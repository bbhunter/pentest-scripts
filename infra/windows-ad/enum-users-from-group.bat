@echo off

setlocal enabledelayedexpansion

:: Getting all groups
for /f "tokens=1* delims=*" %%S in ('net group /domain ^| findstr "\*"') do (
    :: Getting all users from all groups
    for /f "skip=8 tokens=1,2,3" %%G ('net group "%%S" /domain ^| findstr /I /V "Comando"') do (
    	echo %%G
    	echo %%H
    	echo %%I
    ) | findstr /I /V "ECHO" >> users_tmp.txt
)

:: Remove machines name from users list and sort it
type users_tmp.txt | findstr /I /V "\$" | sort /unique >> users_cleaned.txt
type users_tmp.txt | findstr /I "\$" | sort /unique >> machines_cleaned.txt

:: Remove space on the end of the line
(for /f "delims=" %%a in (users_cleaned.txt) do (
    set "line=%%a"
    if "!line:~-1!"==" " set "line=!line:~0,-1!"
    echo(!line!
)) > spray_users.txt

(for /f "delims=" %%a in (machines_cleaned.txt) do (
    set "line=%%a"
    if "!line:~-1!"==" " set "line=!line:~0,-1!"
    echo(!line!
)) > spray_machines.txt

:: Cleanup the temp file
del users_tmp.txt
del users_cleaned.txt
del machines_cleaned.txt

pause

@echo on
