<#
.SYNOPSIS
The script tests a list of usernames with a given password and domain, and outputs the results to the terminal and a file if specified.
#>

param(
  [Parameter(Mandatory=$true,Position=0)]
  [string]$Domain,
  [Parameter(Mandatory=$true,Position=1)]
  [string]$UserList,
  [string]$Username,
  [Parameter(Mandatory=$true,Position=2)]
  [string]$Password,
  [Parameter(Position=3)]
  [switch]$OutFile
)

If ($Username -and $UserList) {
  Write-Output "Please choose only one parameter: either UserList or Username."
  return
}

If ($UserList) {
  If (!(Test-Path $UserList)) {
    Write-Output "The UserList file path is invalid."
    return
  } else {
    $Usernames = Get-Content -Path $UserList
  }
} else {
  If (!$Username) {
    Write-Output "Please provide a value for the Username parameter."
    return
  }
  $Usernames = @($Username)
}

If (!$Password) {
  Write-Output "Please provide a password string."
  return
}

If (!$Domain) {
  Write-Output "Please provide a domain string."
  return
}

$SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force

Foreach ($User in $Usernames) {
  $Credential = New-Object System.Management.Automation.PSCredential("$Domain\" + $User, $SecurePassword)

  If (Test-Credential $Credential) {
    $Result = "$($User): valid credentials"
    Write-Output $Result
    If ($OutFile) {
      Add-Content -Path "results.txt" -Value $Result
    }
  }
}
